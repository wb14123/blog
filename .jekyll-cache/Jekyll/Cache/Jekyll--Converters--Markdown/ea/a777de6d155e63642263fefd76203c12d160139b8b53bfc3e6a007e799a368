I"‘$<p>I migrated my Arch Linux installation to ZFS recently. This article describes why and how I did that.</p>

<h2 id="why-zfs">Why ZFS?</h2>

<p>ZFS is a very advanced file system that has many handful features. I first knew it many years ago, when I installed FreeNAS for fun. FreeNAS is an OS made for NAS based on FreeBSD. When I played with it, the features of ZFS really shocked me and let me realised what a file system can really do. I will list the features of ZFS that I‚Äôm using and not usually avaliable in traditional file systems:</p>

<ul>
  <li>Snapshot: It is really easy to take a snapshot. Because ZFS has copy-on-write feature, so a snapshot doesn‚Äôt take any space until you change some content on the file system. It makes backup way much cheaper and easier. This is the biggest feature that let me want to migrate to ZFS.</li>
  <li>RAIDZ: The traditional raid hides the disks from the file system. But for ZFS, you can use raidz which the file system can see the topological of disks so that it can optimize the I/O based on the information.</li>
  <li>Dataset: You can create many datasets in a zfs pool. Which can have different configurations based on the use case.</li>
  <li>L2 Cache: You can use hard disk drives as the file system and add SDD as read or write cache. Which is a very good balance between the storage space, speed and the price.</li>
  <li>Send/Recv: ZFS has commands to send the datasets and snapshots to another dataset or a remote machine. Which makes the offline backup much easier and cheaper.</li>
  <li>Compression: By compression you can save both storage space and make the read/write faster. And you can set different compression algorithm for different use cases.</li>
</ul>

<p>But back then ZFS is not well supported on Linux so I used ext4. Then I had an internship at Redhat and realised ext4 was really an old file system so I migrated to XFS. Until now, my storage configuration is one 128G SSD for the system (root partition). Two 2TB HDDs as a RAID1 array to store all the other data. I backup the system from SDD to HDD regularly in case of the SDD fails. And I don‚Äôt have any way to protect me from deleting files by mistake.</p>

<h2 id="why-not-freebsd">Why not FreeBSD?</h2>

<p>It is very nature to use BSD with ZFS since it is supported by deafult. With linux, you must install another kernel module which is not native supported by kernel. And Linus just said ‚Äúdon‚Äôt use ZFS‚Äù somedays ago. So I was seriously thinking about change my OS to FreeBSD. Compared to Arch Linux, the system is more security because all the packages are native supported by the FreeBSD developer and the port system also has a lot of softwares. But finally something stops me from migrating to FreeBSD:</p>

<ul>
  <li>The game support. Last year, game on Linux finally breaks out because of the Poton on Steam. Though I don‚Äôt play games a lot, it‚Äôs still a pity to have no game to play.</li>
  <li>FreeBSD starts using ZFS on Linux as the upstream of ZFS. So with the bigger community, ZFS on Linux may has better support and more features in the future.</li>
  <li>It‚Äôs a risk to migrate to a new system. Arch Linux works great for me for a long time. If the new installation doesn‚Äôt work, it‚Äôs time consuming to recover the system. And it says FreeBSD doesn‚Äôt have a good support on Nvidia graphic card, which I‚Äôm currently using.</li>
  <li>FreeBSD‚Äôs Jails are much mature than Containers on Linux. And I really hate Docker for its deamon running as root. Docker also has bad community reputation (e.g. changing its community version‚Äôs name). Rkt from Core OS is much better but both Core OS and Rkt are dead after the acquire of Redhat. But finally I found Podman. So I can compromise at this point. Containers also has bigger community. For example, the Nextcloud I‚Äôm using has official image so I don‚Äôt need to build my own one.</li>
</ul>

<h2 id="how-to-migrate-to-zfs">How to Migrate to ZFS?</h2>

<h3 id="1-backup-the-data">1. Backup the Data</h3>

<p>My disks and partitions are like this before the migration:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- SDD
  + / (root)
  + /boot
- RAID1 (hdd1, hdd2)
  + /data
</code></pre></div></div>

<p>I only backup my data disks because I will not use my system disk for the ZFS pool at the creation time. I will use it as cache which can be added later. An important note is to <strong>use <code class="language-plaintext highlighter-rouge">tar</code> or <code class="language-plaintext highlighter-rouge">rsync</code> to backup data</strong>. Don‚Äôt use <code class="language-plaintext highlighter-rouge">cp</code>, it will break the file permissions and links.</p>

<h3 id="2-install-zfs-kernel-modules-and-utils">2. Install ZFS Kernel Modules and Utils</h3>

<p>Follow the <a href="https://wiki.archlinux.org/index.php/ZFS#Installation">Arch Linux‚Äôs ZFS wiki</a> to do that. I also enabled the <a href="https://wiki.archlinux.org/index.php/Unofficial_user_repositories#archzfs">ArchZFS repo</a> so I don‚Äôt need to build it from AUR. This repo is signed so it is more secure.</p>

<h3 id="3-create-zfs-pool-and-dataset">3. Create ZFS Pool and Dataset</h3>

<p>I added another HDD for the ZFS pool in order to make a raidz1 pool (like raid5), which doubles the current storage space with raid1. Then create a dataset for the new root partition. The dataset has native encryption and compression enabled.</p>

<h3 id="4-mount-the-root-dataset-and-copy-the-root-partition">4. Mount the Root Dataset and Copy the Root Partition</h3>

<p>Temparory mount the root dataset to <code class="language-plaintext highlighter-rouge">/mnt</code>. Then follow the Arch Linux wiki about <a href="https://wiki.archlinux.org/index.php/Install_Arch_Linux_from_existing_Linux#From_a_host_running_Arch_Linux">installing from a host running Arch Linux</a>.</p>

<h3 id="5-make-new-boot-image-and-config-bootloader">5. Make New Boot Image and Config Bootloader</h3>

<p>I was trying to install boot partition into the ZFS but failed after many attemps. At last I decide just use the old boot partition and sync them to ZFS as backup.</p>

<p>So follow <a href="https://wiki.archlinux.org/index.php/Install_Arch_Linux_on_ZFS">install Arch Linux on ZFS wiki</a>. After the regular installation, add <code class="language-plaintext highlighter-rouge">zfs</code> in <code class="language-plaintext highlighter-rouge">/etc/mkinitcpio.conf</code> <code class="language-plaintext highlighter-rouge">HOOKS</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HOOKS=(base udev autodetect modconf block keyboard zfs filesystems)
</code></pre></div></div>

<p>Then using <code class="language-plaintext highlighter-rouge">mkinitcpio -p</code> to make new boot image. (You may want to backup old images <code class="language-plaintext highlighter-rouge">/boot/initramfs-linux.img</code> and <code class="language-plaintext highlighter-rouge">/boot/vmlinuz-linux</code> before this step).</p>

<p>Then in <code class="language-plaintext highlighter-rouge">/boot/grub/grub.cfg</code>, change the root filesystem to zfs, like this (in the menuentry):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>linux   /vmlinuz-linux root=ZFS=zroot/root rw  loglevel=3 quiet
</code></pre></div></div>

<p>Which <code class="language-plaintext highlighter-rouge">zroot/root</code> is the root dataset.</p>

<h3 id="6-config-mount-points">6. Config Mount Points</h3>

<p>Reconfig the root dataset‚Äôs mount point to <code class="language-plaintext highlighter-rouge">/</code> and add the configuration in <code class="language-plaintext highlighter-rouge">/etc/fstab</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zroot/root / zfs defaults,noatime 0 0
</code></pre></div></div>

<p>Don‚Äôt forget to set the auto import:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl enable zfs-import-cache
zpool set cachefile=/etc/zfs/zpool.cache &lt;pool&gt;
systemctl enable zfs-mount
systemctl enable zfs.target
</code></pre></div></div>

<p>Also need to input the passphrase if using encryption. Follow the <a href="https://wiki.archlinux.org/index.php/ZFS">Arch Linux‚Äôs ZFS wiki</a> to do that.</p>

<h3 id="7-restart-and-config-new-system">7. Restart and Config New System</h3>

<p>After the reboot, the system should boot into the new root. Then cleanup the old root partition and add it as the cache of the pool: <code class="language-plaintext highlighter-rouge">zpool add -f zroot cache &lt;partition-uuid&gt;</code>. Then create other datasets and move back all the old data.</p>

<p>Now I can make different datasets for different purpose. For example, make a dataset for nextcloud container‚Äôs storage. Make a highly compressed dataset for backup files from other machine, and so on.</p>

<p>After the migration, the first boot is slower than before because the root system is migrated to HDD. But the most useful files will be cached into SSD and it feels the same as before after a while. Now I‚Äôm very happy with the current setup and super excited about all the advanced features of ZFS! Happy hacking!</p>
:ET