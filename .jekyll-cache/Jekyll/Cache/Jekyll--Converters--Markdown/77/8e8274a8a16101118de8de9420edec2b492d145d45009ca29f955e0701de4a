I"<p><a href="https://www.yubico.com/">YubiKey</a> is a kind of hardware security token. The idea is to authenticate a person not only based on something he knows (password), but also on something he owns. It can be a digital file, but a more secure option would be a hardware token like Yubikey since no one can steal it without physical access. I use it for a lot of services. Not surprisingly, it can also be used in ssh authentication. But the official Yubikey tutorials are not very straightforward and the <del>Archlinux wiki pages are more generic instead of Yubikey specific</del>. So in this article, I’ll introduce how to setup ssh to include Yubikey in the authentication process. The operating system I’m using is Arch Linux, but the process for other Linux systems should be very similar.</p>

<h2 id="generate-openssh-hardware-token">Generate OpenSSH Hardware Token</h2>

<p>The most easy way is to generate a ssh key file based on Yubikey. OpenSSH supports this since 8.2.</p>

<ol>
  <li>Run <code class="language-plaintext highlighter-rouge">ssh-keygen -t ecdsa-sk</code></li>
  <li>Touch the Yubikey for a few seconds.</li>
</ol>

<p>Then you can use the generated ssh key like other key files with <code class="language-plaintext highlighter-rouge">-i</code> option. After type in the login command, you need to touch Yubikey for a few seconds, then you should be able to login.</p>

<h2 id="use-pam"><del>Use PAM</del></h2>

<p><strong>Update: this way only works while the key is plugged into the ssh host, which makes it useless for SSH. However, it’s still useful for things like local login.</strong></p>

<p>A more generic way is to use <a href="https://en.wikipedia.org/wiki/Linux_PAM">PAM</a> with Yubikey. It’s a modular authentication mechanism not only for SSH, but also for lots of other things like local login.</p>

<h3 id="1-install-packages">1. Install packages</h3>

<p>PAM should be installed by default for Archlinux. So the only package we need to install is the PAM module for Yubikey <code class="language-plaintext highlighter-rouge">pam-u2f</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo pacman -S pam-u2f
</code></pre></div></div>

<h3 id="2-generate-u2f-mapping-file">2. Generate u2f mapping file</h3>

<p>Run this command first:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pamu2fcfg -u&lt;username&gt; # Replace &lt;username&gt; by your username
</code></pre></div></div>

<p>Touch your Yubikey for a few seconds and save the command result to a configuration file, for example, <code class="language-plaintext highlighter-rouge">/etc/u2f_mappings</code>.</p>

<h3 id="3-config-pam-for-ssh">3. Config PAM for SSH</h3>

<p>The PAM config file for ssh is located at <code class="language-plaintext highlighter-rouge">/etc/pam.d/sshd</code>. In order to add Yubikey as part of the authentication, add this line to the file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>auth required pam_u2f.so authfile=/etc/u2f_mappings
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">required</code> means Yubikey authentication is necessary. The other options are <code class="language-plaintext highlighter-rouge">requisite</code>, <code class="language-plaintext highlighter-rouge">sufficient</code> and <code class="language-plaintext highlighter-rouge">optional</code>. Refer to <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system-level_authentication_guide/pam_configuration_files">Redhat document</a> for more details.</p>

<p>The parts after <code class="language-plaintext highlighter-rouge">pam_u2f.so</code> are the parameters. <code class="language-plaintext highlighter-rouge">authfile</code> is one of them. For all the supported parameters, refer to <a href="https://developers.yubico.com/pam-u2f/">Yubico pam-u2f document</a>.</p>

<h3 id="4-config-ssh-to-include-password-authentication">4. Config SSH to include password authentication</h3>

<p>In order to actually use PAM in ssh, ssh server needs to include password as part of authorization methods. The configuration is <code class="language-plaintext highlighter-rouge">AuthenticationMethods</code> in <code class="language-plaintext highlighter-rouge">sshd_config</code>. For example, if you want to use password + Yubikey + ssh key file, you can config it like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AuthenticationMethods "publickey,password"
</code></pre></div></div>

<p>And make sure <code class="language-plaintext highlighter-rouge">PasswordAuthentication</code> and <code class="language-plaintext highlighter-rouge">ChallengeResponseAuthentication</code> are both <code class="language-plaintext highlighter-rouge">yes</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PasswordAuthentication Yes
ChallengeResponseAuthentication Yes
</code></pre></div></div>

<p>After this, restart sshd then you can login with Yubikey authentication: type in ssh login command, input user password and press enter, touch the Yubikey for a few seconds, then you should be able to login!</p>
:ET